<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å°å£ç¾é‡‘ç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼ˆæ”¯åº—åˆ¥ãƒ»å¯¾è±¡æœˆåˆ¥ï¼‰</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="mb-4">ğŸ¢ å°å£ç¾é‡‘ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆæ”¯åº—åˆ¥ãƒ»å¯¾è±¡æœˆåˆ¥ï¼‰</h1>

    <!-- ===================== -->
    <!-- ğŸ“¤ CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
    <!-- ===================== -->
    <div class="card p-3 mb-4">
      <h5>ğŸ“¤ å°å£ç¾é‡‘CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>
      <form id="upload-form">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="branch-name" class="form-label">æ”¯åº—å</label>
            <input type="text" id="branch-name" class="form-control" placeholder="ä¾‹ï¼šå¤§é˜ªæ”¯åº—" required />
          </div>
          <div class="col-md-3">
            <label for="period" class="form-label">å¯¾è±¡æœˆ</label>
            <input type="month" id="period" class="form-control" required />
          </div>
          <div class="col-md-5">
            <label for="csv-file" class="form-label">CSVãƒ•ã‚¡ã‚¤ãƒ«</label>
            <input type="file" id="csv-file" accept=".csv" class="form-control" required />
          </div>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-primary" type="submit">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        </div>
      </form>
      <div id="upload-status" class="mt-3"></div>
    </div>

    <!-- ===================== -->
    <!-- ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å±¥æ­´ -->
    <!-- ===================== -->
    <div class="card p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å±¥æ­´</h5>
        <div class="d-flex gap-2">
          <input type="text" id="history-branch" class="form-control" style="width: 150px;" placeholder="æ”¯åº—å" />
          <input type="month" id="history-period" class="form-control" style="width: 150px;" />
          <button class="btn btn-outline-primary" id="reload-history">ğŸ”„ æ›´æ–°</button>
        </div>
      </div>

      <table class="table table-striped mt-3" id="expense-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>æ”¯åº—å</th>
            <th>å¯¾è±¡æœˆ</th>
            <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
            <th>ä»¶æ•°</th>
            <th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="expense-body"></tbody>
      </table>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <button class="btn btn-outline-secondary btn-sm" id="prevPage">â† å‰ã¸</button>
        <span id="pageInfo" class="fw-bold"></span>
        <button class="btn btn-outline-secondary btn-sm" id="nextPage">æ¬¡ã¸ â†’</button>
      </div>
    </div>

    <!-- ===================== -->
    <!-- ğŸ” ãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢ï¼‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <!-- ===================== -->
    <div class="card p-3 mt-4">
      <h5>ğŸ” æ”¯åº—åãƒ»å¯¾è±¡æœˆã§æ¤œç´¢ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h5>

      <div class="row g-3 align-items-end mt-2">
        <div class="col-md-3">
          <label class="form-label">æ”¯åº—å</label>
          <input type="text" id="filter-branch" class="form-control" placeholder="ä¾‹ï¼šæ±äº¬æ”¯åº—" />
        </div>
        <div class="col-md-3">
          <label class="form-label">å¯¾è±¡æœˆ</label>
          <input type="month" id="filter-period" class="form-control" />
        </div>
        <div class="col-md-3">
          <label class="form-label">å‹˜å®šç§‘ç›®</label>
          <input type="text" id="filter-account" class="form-control" placeholder="ä¾‹ï¼šæ—…è²»äº¤é€šè²»,ä¼šè­°è²»" />
        </div>
        <div class="col-md-4">
          <label class="form-label">é‡‘é¡ï¼ˆæ•°å€¤æ¡ä»¶ï¼‰</label>
          <div class="input-group">
            <select id="filter-num-op" class="form-select">
              <option value="gt">ï¼</option>
              <option value="lt">ï¼œ</option>
              <option value="ge">â‰§</option>
              <option value="le">â‰¦</option>
              <option value="eq">ï¼</option>
              <option value="between">ç¯„å›²ï¼ˆmin,maxï¼‰</option>
            </select>
            <input type="text" id="filter-num-val" class="form-control" placeholder="ä¾‹ï¼š10000 ã¾ãŸã¯ 5000,20000" />
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">æ—¥ä»˜ç¯„å›²</label>
          <div class="input-group">
            <input type="date" id="filter-date-from" class="form-control" />
            <span class="input-group-text">ã€œ</span>
            <input type="date" id="filter-date-to" class="form-control" />
          </div>
        </div>
      </div>

      <div class="mt-3 text-end">
        <button class="btn btn-outline-primary me-2" id="previewByFilters">ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º</button>
        <button class="btn btn-success" id="downloadByFilters">ğŸ’¾ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </div>

    <!-- ===================== -->
    <!-- ğŸ“Š ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º -->
    <!-- ===================== -->
    <div id="preview-area" class="mt-3" style="display:none;">
      <h6>ğŸ“Š ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆæ”¯åº—åˆ¥ãƒ»å¯¾è±¡æœˆåˆ¥ï¼‰</h6>
      <div class="table-responsive">
        <table class="table table-bordered table-sm" id="preview-table">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
          <button class="btn btn-outline-secondary btn-sm" id="pvPrev">â† å‰ã¸</button>
          <span id="pvInfo" class="mx-2 small text-muted"></span>
          <button class="btn btn-outline-secondary btn-sm" id="pvNext">æ¬¡ã¸ â†’</button>
        </div>
        <div class="input-group input-group-sm" style="width: 180px;">
          <label class="input-group-text" for="pvPageSize">ä»¶æ•°</label>
          <select id="pvPageSize" class="form-select">
            <option value="20">20</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
        </div>
      </div>
      <p id="preview-count" class="text-muted small mb-0"></p>
    </div>
  </div>

  <!-- ===================== -->
  <!-- ğŸ§¾ è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <!-- ===================== -->
  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            ğŸ§¾ æ˜ç´°è¡¨ç¤º <span id="detail-branch" class="text-primary"></span>
            <small class="text-muted" id="detail-period"></small>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detail-body">
          <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
        <div class="modal-footer d-flex justify-content-between align-items-center">
          <div>
            <button class="btn btn-outline-secondary btn-sm" id="detailPrev">â† å‰ã¸</button>
            <span id="detailPageInfo" class="mx-2 small text-muted"></span>
            <button class="btn btn-outline-secondary btn-sm" id="detailNext">æ¬¡ã¸ â†’</button>
          </div>
          <div class="d-flex align-items-center">
            <button class="btn btn-outline-success btn-sm me-2" id="downloadFilteredCSV">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <div class="input-group input-group-sm" style="width:180px;">
              <label class="input-group-text" for="detailPageSize">ä»¶æ•°</label>
              <select id="detailPageSize" class="form-select">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== -->
  <!-- ğŸ’» JavaScript -->
  <!-- ===================== -->
  <script>
    // === åŸºæœ¬è¨­å®šï¼ˆã©ã®ãƒ›ã‚¹ãƒˆã§ã‚‚å‹•ãçµ¶å¯¾URLã‚’è‡ªå‹•ç”Ÿæˆï¼‰ ===
    const ORIGIN = window.location.origin;                         // ä¾‹: http://127.0.0.1:8000
    const API_BASE = `${ORIGIN}/api/expenses`;
    const BASIC_AUTH_HEADER = "Basic " + btoa("admin:secret123");

    // èªè¨¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ç¢ºå®Ÿã«å‡ºã™ï¼ˆåˆå›ã‚¢ã‚¯ã‚»ã‚¹ã§401ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ï¼‰
    (async () => {
      try {
        const res = await fetch(ORIGIN + "/");
        if (res.status === 401) {
          window.location = ORIGIN + "/?redirect=" + encodeURIComponent(window.location.href);
        }
      } catch (e) {
        console.warn("åˆå›èªè¨¼ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—:", e);
      }
    })();

    // å…±é€šfetchï¼ˆBasicèªè¨¼ãƒ˜ãƒƒãƒ€ä»˜ä¸ï¼‰
    async function apiFetch(url, options = {}) {
      return fetch(url, {
        ...options,
        headers: {
          ...(options.headers || {}),
          Authorization: BASIC_AUTH_HEADER,
        },
        credentials: "include",
      });
    }

    // ========= çŠ¶æ…‹ =========
    let allData = [];
    let currentPage = 1;
    const pageSize = 10;

    const detailState = {
      datasetId: null,
      filterVal: "",
      page: 1,
      size: 20,
      total: 0,
      modal: null,
      metaBranch: null,
      metaPeriod: null
    };

    const previewState = {
      page: 1,
      size: 50,
      total: 0,
      pages: 0,
      filters: null
    };

    // ========= ãƒ•ã‚£ãƒ«ã‚¿é–¢é€£ =========
    function getFilters() {
      const branchVal = document.getElementById("filter-branch").value.trim();
      const periodVal = document.getElementById("filter-period").value;
      const accountVal = document.getElementById("filter-account").value.trim();

      const filters = {
        branch: branchVal || null,
        period: periodVal || null,
        string: []
      };

      if (accountVal) {
        filters.string.push({ col: "å‹˜å®šç§‘ç›®", val: accountVal });
      }

      // é‡‘é¡ï¼ˆæ•°å€¤æ¡ä»¶ï¼‰
      const op = document.getElementById("filter-num-op").value;
      const numVal = document.getElementById("filter-num-val").value.trim();
      if (numVal) {
        // ã‚µãƒ¼ãƒå´ã§å¯¾å¿œã—ã¦ã„ãªã‘ã‚Œã°ã€ã“ã“ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãŠã„ã¦OK
        filters.num = { op, val: numVal }; // å‚è€ƒï¼šå°†æ¥ã®æ‹¡å¼µç”¨ã«æ¸©å­˜
      }

      // æ—¥ä»˜ç¯„å›²
      const df = document.getElementById("filter-date-from").value;
      const dt = document.getElementById("filter-date-to").value;
      if (df || dt) {
        filters.date = { from: df || null, to: dt || null }; // å‚è€ƒï¼šå°†æ¥ã®æ‹¡å¼µç”¨ã«æ¸©å­˜
      }

      return filters;
    }

    // URLç”Ÿæˆï¼ˆdownload_all_json / download_all_csv å…±é€šï¼‰
    function buildFilterUrl(filters, json = false, page = 1, size = 50) {
      const endpoint = json
        ? `${API_BASE}/download_all_json`
        : `${API_BASE}/download_all_csv`;
      const url = new URL(endpoint); // API_BASE ãŒçµ¶å¯¾URLãªã®ã§OK

      if (filters?.branch) url.searchParams.append("branch", filters.branch);
      if (filters?.period) url.searchParams.append("period", filters.period);

      if (filters?.string && filters.string.length > 0) {
        filters.string.forEach(f => {
          url.searchParams.append("filter_col", f.col);
          url.searchParams.append("filter_val", f.val);
        });
      }

      // â€» num/date ã¯å°†æ¥æ‹¡å¼µå‘ã‘ï¼ˆç¾APIãŒæœªå¯¾å¿œãªã‚‰é€ã‚‰ãªã„ï¼‰
      // if (filters?.num) { ... }
      // if (filters?.date) { ... }

      if (json) {
        url.searchParams.append("page", page ?? 1);
        url.searchParams.append("size", size ?? 50);
      }
      return url.toString();
    }

    // ========= ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =========
    document.getElementById("upload-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const branch = document.getElementById("branch-name").value.trim();
      const period = document.getElementById("period").value;
      const file = document.getElementById("csv-file").files[0];

      if (!branch || !period || !file) {
        document.getElementById("upload-status").innerHTML = `<p class="text-danger">æ”¯åº—åãƒ»å¯¾è±¡æœˆãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…é ˆã§ã™ã€‚</p>`;
        return;
      }

      const formData = new FormData();
      formData.append("branch_name", branch);
      formData.append("period", period);
      formData.append("file", file);

      try {
        const res = await apiFetch(`${API_BASE}/`, {
          method: "POST",
          body: formData,
        });
        const data = await res.json();

        if (!res.ok) {
          document.getElementById("upload-status").innerHTML =
            `<p class="text-danger">âŒ ${data.detail || "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã€ŒCSVãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ10MBä»¥ä¸‹ï¼‰ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€"}</p>`;
          return;
        }

        document.getElementById("upload-status").innerHTML =
          `<p class="text-success">âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼š${data.file}ï¼ˆ${data.row_count} ä»¶ï¼‰</p>`;

        await loadExpenses();      // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
        document.getElementById("upload-form").reset();

      } catch (err) {
        console.error(err);
        document.getElementById("upload-status").innerHTML =
          `<p class="text-danger">âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
      }
    });

    // ========= å±¥æ­´ä¸€è¦§ =========
    async function loadExpenses(branchFilter = "", periodFilter = "") {
      try {
        let url = `${API_BASE}`;
        const params = new URLSearchParams();
        if (branchFilter) params.append("branch", branchFilter);
        if (periodFilter) params.append("period", periodFilter);
        const qs = params.toString();
        if (qs) url += "?" + qs;

        const res = await apiFetch(url);
        if (!res.ok) {
          alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          return;
        }
        const json = await res.json();
        allData = Array.isArray(json) ? json : (json.data || []);
        currentPage = 1;
        renderListTable();
      } catch (e) {
        console.error("loadExpenses error:", e);
        alert("å±¥æ­´ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    }

    function renderListTable() {
      const tbody = document.getElementById("expense-body");
      tbody.innerHTML = "";

      if (!Array.isArray(allData) || allData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-muted text-center">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
        document.getElementById("pageInfo").textContent = "";
        document.getElementById("prevPage").disabled = true;
        document.getElementById("nextPage").disabled = true;
        return;
      }

      const start = (currentPage - 1) * pageSize;
      const pageData = allData.slice(start, start + pageSize);

      pageData.forEach((item) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${item.branch_name || "ï¼"}</td>
          <td>${item.period || "ï¼"}</td>
          <td>${item.file_name}</td>
          <td>${item.row_count}</td>
          <td>${item.uploaded_at}</td>
          <td>
            <button class="btn btn-sm btn-info me-1 btn-detail">è©³ç´°</button>
            <button class="btn btn-sm btn-success btn-dl">DL</button>
          </td>
        `;
        tbody.appendChild(tr);

        tr.querySelector(".btn-detail").addEventListener("click", () => showDetails(item.id));
        tr.querySelector(".btn-dl").addEventListener("click", () => downloadCSV(item.branch_name, item.period));
      });

      const totalPages = Math.ceil(allData.length / pageSize) || 1;
      document.getElementById("pageInfo").textContent = `ãƒšãƒ¼ã‚¸ ${currentPage} / ${totalPages}`;
      document.getElementById("prevPage").disabled = currentPage <= 1;
      document.getElementById("nextPage").disabled = currentPage >= totalPages;
    }

    document.getElementById("reload-history").addEventListener("click", async () => {
      const branch = document.getElementById("history-branch").value.trim();
      const period = document.getElementById("history-period").value;
      await loadExpenses(branch, period);
    });

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) { currentPage--; renderListTable(); }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      const totalPages = Math.ceil(allData.length / pageSize) || 1;
      if (currentPage < totalPages) { currentPage++; renderListTable(); }
    });

    // ========= è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« =========
    async function showDetails(datasetId, filterVal = "") {
      detailState.datasetId = datasetId;
      detailState.filterVal = filterVal;
      detailState.page = 1;
      detailState.size = parseInt(document.getElementById("detailPageSize").value, 10) || 20;

      await loadDetailPage();

      if (!detailState.modal) {
        detailState.modal = new bootstrap.Modal(document.getElementById("detailModal"));
      }
      detailState.modal.show();
    }

    async function loadDetailPage() {
      const { datasetId, filterVal, page, size } = detailState;
      let url = `${API_BASE}/${datasetId}?page=${page}&size=${size}`;
      if (filterVal) {
        url += `&filter_col=${encodeURIComponent("ç¤¾å“¡å")}&filter_val=${encodeURIComponent(filterVal)}`;
      }

      const res = await apiFetch(url);
      const data = await res.json();
      const body = document.getElementById("detail-body");

      if (!res.ok) {
        body.innerHTML = `<p class="text-danger">${data.detail || "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"}</p>`;
        return;
      }

      const rows = data.data || [];
      detailState.metaBranch = data.meta?.branch_name || rows[0]?.["æ”¯åº—å"] || "";
      detailState.metaPeriod = data.meta?.period || rows[0]?.["å¯¾è±¡æœˆ"] || "";
      document.getElementById("detail-branch").textContent = detailState.metaBranch;
      document.getElementById("detail-period").textContent = detailState.metaPeriod;

      const customOrder = ["æ”¯åº—å", "å¯¾è±¡æœˆ", "æ—¥ä»˜", "é‡‘é¡", "å‹˜å®šç§‘ç›®", "å‚™è€ƒ"];
      const headers = rows[0] ? customOrder.filter(h => Object.keys(rows[0]).includes(h)) : [];

      body.innerHTML = rows.length
        ? `<table class="table table-bordered table-sm">
             <thead><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead>
             <tbody>${rows.map(r => `<tr>${headers.map(h => `<td>${r[h] ?? ""}</td>`).join("")}</tr>`).join("")}</tbody>
           </table>`
        : "<p>è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—</p>";

      detailState.total = data.meta?.total || rows.length;
      const totalPages = Math.ceil(Math.max(detailState.total, 1) / size);
      document.getElementById("detailPageInfo").textContent = `ãƒšãƒ¼ã‚¸ ${page} / ${totalPages}ï¼ˆå…¨ ${detailState.total} ä»¶ï¼‰`;
    }

    document.getElementById("detailPrev").addEventListener("click", async () => {
      if (detailState.page > 1) {
        detailState.page -= 1;
        await loadDetailPage();
      }
    });

    document.getElementById("detailNext").addEventListener("click", async () => {
      const maxPage = Math.ceil(Math.max(detailState.total, 1) / detailState.size);
      if (detailState.page < maxPage) {
        detailState.page += 1;
        await loadDetailPage();
      }
    });

    document.getElementById("detailPageSize").addEventListener("change", async (e) => {
      detailState.size = parseInt(e.target.value, 10) || 20;
      detailState.page = 1;
      await loadDetailPage();
    });

    document.getElementById("downloadFilteredCSV").addEventListener("click", () => {
      const url = new URL(`${API_BASE}/download_all_csv`);
      if (detailState.metaBranch) url.searchParams.append("branch", detailState.metaBranch);
      if (detailState.metaPeriod) url.searchParams.append("period", detailState.metaPeriod);
      if (detailState.filterVal) {
        url.searchParams.append("filter_col", "ç¤¾å“¡å");
        url.searchParams.append("filter_val", detailState.filterVal);
      }
      window.open(url.toString(), "_blank");
    });

    // ========= CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå±¥æ­´è¡Œã®DLãƒœã‚¿ãƒ³ç”¨ï¼‰ =========
    function downloadCSV(branch, period) {
      const url = new URL(`${API_BASE}/download_all_csv`);
      if (branch) url.searchParams.append("branch", branch);
      if (period) url.searchParams.append("period", period);
      window.open(url.toString(), "_blank");
    }

// =======================
// ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæ”¯åº—åãƒ»å¯¾è±¡æœˆãƒ»é‡‘é¡ãƒ»å‹˜å®šç§‘ç›®ãƒ»å‚™è€ƒï¼‰
// =======================
async function loadPreviewPage() {
  const area = document.getElementById("preview-area");
  const thead = document.querySelector("#preview-table thead");
  const tbody = document.querySelector("#preview-table tbody");
  const info = document.getElementById("pvInfo");
  const btnPrev = document.getElementById("pvPrev");
  const btnNext = document.getElementById("pvNext");

  const url = buildFilterUrl(previewState.filters, true, previewState.page, previewState.size);
  const res = await apiFetch(url);

  let data = {};
  try {
    data = await res.json();
  } catch (_) {
    data = {};
  }

  // âŒ ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®å‡¦ç†
  if (!res.ok || !data.data || data.data.length === 0) {
    thead.innerHTML = "";
    tbody.innerHTML = "";
    document.getElementById("preview-count").textContent = "è©²å½“ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
    area.style.display = "block";
    btnPrev.disabled = btnNext.disabled = true;
    info.textContent = "";
    return;
  }

  const rows = data.data;
  previewState.total = data.meta?.total ?? rows.length;
  previewState.pages = Math.ceil(Math.max(previewState.total, 1) / previewState.size);

  // âœ… è¡¨ç¤ºé †ã‚’å›ºå®š
  const headers = ["æ”¯åº—å", "å¯¾è±¡æœˆ", "é‡‘é¡", "å‹˜å®šç§‘ç›®", "å‚™è€ƒ"];

  // ğŸ§­ ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ
  thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`;

  // ğŸ§¾ ãƒ‡ãƒ¼ã‚¿è¡Œç”Ÿæˆ
  tbody.innerHTML = rows
    .map(r => `<tr>${headers.map(h => `<td>${r?.[h] ?? ""}</td>`).join("")}</tr>`)
    .join("");

  // ğŸ“ ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãƒ»ä»¶æ•°è¡¨ç¤º
  info.textContent = `ãƒšãƒ¼ã‚¸ ${previewState.page} / ${previewState.pages}ï¼ˆå…¨ ${previewState.total} ä»¶ï¼‰`;
  btnPrev.disabled = previewState.page <= 1;
  btnNext.disabled = previewState.page >= previewState.pages;
  document.getElementById("preview-count").textContent =
    `è¡¨ç¤ºä»¶æ•°ï¼š${rows.length} ä»¶ï¼ˆ1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Š ${previewState.size} ä»¶ï¼‰`;

  area.style.display = "block";
}


    document.getElementById("previewByFilters").addEventListener("click", async () => {
      previewState.filters = getFilters();
      previewState.page = 1;
      previewState.size = parseInt(document.getElementById("pvPageSize").value, 10) || 50;
      await loadPreviewPage();
    });

    document.getElementById("pvPrev").addEventListener("click", async () => {
      if (previewState.page > 1) {
        previewState.page -= 1;
        await loadPreviewPage();
      }
    });

    document.getElementById("pvNext").addEventListener("click", async () => {
      if (previewState.page < previewState.pages) {
        previewState.page += 1;
        await loadPreviewPage();
      }
    });

    document.getElementById("pvPageSize").addEventListener("change", async (e) => {
      previewState.size = parseInt(e.target.value, 10) || 50;
      previewState.page = 1;
      await loadPreviewPage();
    });

    document.getElementById("downloadByFilters").addEventListener("click", () => {
      const url = buildFilterUrl(getFilters(), false);
      window.open(url, "_blank");
    });

    // ========= åˆæœŸãƒ­ãƒ¼ãƒ‰ =========
    window.addEventListener("DOMContentLoaded", async () => {
      await loadExpenses();
    });
  </script>
</body>
</html>
