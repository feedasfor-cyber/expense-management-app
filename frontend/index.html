<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>小口現金管理ツール（支店別・対象月別）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="mb-4">🏢 小口現金アップローダー（支店別・対象月別）</h1>

    <!-- ===================== -->
    <!-- 📤 CSVアップロード -->
    <!-- ===================== -->
    <div class="card p-3 mb-4">
      <h5>📤 小口現金CSVアップロード</h5>
      <form id="upload-form">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="branch-name" class="form-label">支店名</label>
            <input type="text" id="branch-name" class="form-control" placeholder="例：大阪支店" required />
          </div>
          <div class="col-md-3">
            <label for="period" class="form-label">対象月</label>
            <input type="month" id="period" class="form-control" required />
          </div>
          <div class="col-md-5">
            <label for="csv-file" class="form-label">CSVファイル</label>
            <input type="file" id="csv-file" accept=".csv" class="form-control" required />
          </div>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-primary" type="submit">アップロード</button>
        </div>
      </form>
      <div id="upload-status" class="mt-3"></div>
    </div>

    <!-- ===================== -->
    <!-- 📋 アップロード履歴 -->
    <!-- ===================== -->
    <div class="card p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">📋 アップロード履歴</h5>
        <div class="d-flex gap-2">
          <input type="text" id="history-branch" class="form-control" style="width: 150px;" placeholder="支店名" />
          <input type="month" id="history-period" class="form-control" style="width: 150px;" />
          <button class="btn btn-outline-primary" id="reload-history">🔄 更新</button>
        </div>
      </div>

      <table class="table table-striped mt-3" id="expense-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>支店名</th>
            <th>対象月</th>
            <th>ファイル名</th>
            <th>件数</th>
            <th>アップロード日時</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="expense-body"></tbody>
      </table>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <button class="btn btn-outline-secondary btn-sm" id="prevPage">← 前へ</button>
        <span id="pageInfo" class="fw-bold"></span>
        <button class="btn btn-outline-secondary btn-sm" id="nextPage">次へ →</button>
      </div>
    </div>

    <!-- ===================== -->
    <!-- 🔍 フィルタ検索＋プレビュー -->
    <!-- ===================== -->
    <div class="card p-3 mt-4">
      <h5>🔍 支店名・対象月で検索してプレビュー／CSVダウンロード</h5>

      <div class="row g-3 align-items-end mt-2">
        <div class="col-md-3">
          <label class="form-label">支店名</label>
          <input type="text" id="filter-branch" class="form-control" placeholder="例：東京支店" />
        </div>
        <div class="col-md-3">
          <label class="form-label">対象月</label>
          <input type="month" id="filter-period" class="form-control" />
        </div>
        <div class="col-md-3">
          <label class="form-label">勘定科目</label>
          <input type="text" id="filter-account" class="form-control" placeholder="例：旅費交通費,会議費" />
        </div>
        <div class="col-md-4">
          <label class="form-label">金額（数値条件）</label>
          <div class="input-group">
            <select id="filter-num-op" class="form-select">
              <option value="gt">＞</option>
              <option value="lt">＜</option>
              <option value="ge">≧</option>
              <option value="le">≦</option>
              <option value="eq">＝</option>
              <option value="between">範囲（min,max）</option>
            </select>
            <input type="text" id="filter-num-val" class="form-control" placeholder="例：10000 または 5000,20000" />
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">日付範囲</label>
          <div class="input-group">
            <input type="date" id="filter-date-from" class="form-control" />
            <span class="input-group-text">〜</span>
            <input type="date" id="filter-date-to" class="form-control" />
          </div>
        </div>
      </div>

      <div class="mt-3 text-end">
        <button class="btn btn-outline-primary me-2" id="previewByFilters">🔍 プレビュー表示</button>
        <button class="btn btn-success" id="downloadByFilters">💾 CSVダウンロード</button>
      </div>
    </div>

    <!-- ===================== -->
    <!-- 📊 プレビュー表示 -->
    <!-- ===================== -->
    <div id="preview-area" class="mt-3" style="display:none;">
      <h6>📊 プレビュー結果（支店別・対象月別）</h6>
      <div class="table-responsive">
        <table class="table table-bordered table-sm" id="preview-table">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
          <button class="btn btn-outline-secondary btn-sm" id="pvPrev">← 前へ</button>
          <span id="pvInfo" class="mx-2 small text-muted"></span>
          <button class="btn btn-outline-secondary btn-sm" id="pvNext">次へ →</button>
        </div>
        <div class="input-group input-group-sm" style="width: 180px;">
          <label class="input-group-text" for="pvPageSize">件数</label>
          <select id="pvPageSize" class="form-select">
            <option value="20">20</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
        </div>
      </div>
      <p id="preview-count" class="text-muted small mb-0"></p>
    </div>
  </div>

  <!-- ===================== -->
  <!-- 🧾 詳細モーダル -->
  <!-- ===================== -->
  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            🧾 明細表示 <span id="detail-branch" class="text-primary"></span>
            <small class="text-muted" id="detail-period"></small>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detail-body">
          <p>読み込み中...</p>
        </div>
        <div class="modal-footer d-flex justify-content-between align-items-center">
          <div>
            <button class="btn btn-outline-secondary btn-sm" id="detailPrev">← 前へ</button>
            <span id="detailPageInfo" class="mx-2 small text-muted"></span>
            <button class="btn btn-outline-secondary btn-sm" id="detailNext">次へ →</button>
          </div>
          <div class="d-flex align-items-center">
            <button class="btn btn-outline-success btn-sm me-2" id="downloadFilteredCSV">CSVダウンロード</button>
            <div class="input-group input-group-sm" style="width:180px;">
              <label class="input-group-text" for="detailPageSize">件数</label>
              <select id="detailPageSize" class="form-select">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== -->
  <!-- 💻 JavaScript -->
  <!-- ===================== -->
  <script>
    // === 基本設定（どのホストでも動く絶対URLを自動生成） ===
    const ORIGIN = window.location.origin;                         // 例: http://127.0.0.1:8000
    const API_BASE = `${ORIGIN}/api/expenses`;
    const BASIC_AUTH_HEADER = "Basic " + btoa("admin:secret123");

    // 認証ポップアップを確実に出す（初回アクセスで401ならログイン画面へ）
    (async () => {
      try {
        const res = await fetch(ORIGIN + "/");
        if (res.status === 401) {
          window.location = ORIGIN + "/?redirect=" + encodeURIComponent(window.location.href);
        }
      } catch (e) {
        console.warn("初回認証チェックに失敗:", e);
      }
    })();

    // 共通fetch（Basic認証ヘッダ付与）
    async function apiFetch(url, options = {}) {
      return fetch(url, {
        ...options,
        headers: {
          ...(options.headers || {}),
          Authorization: BASIC_AUTH_HEADER,
        },
        credentials: "include",
      });
    }

    // ========= 状態 =========
    let allData = [];
    let currentPage = 1;
    const pageSize = 10;

    const detailState = {
      datasetId: null,
      filterVal: "",
      page: 1,
      size: 20,
      total: 0,
      modal: null,
      metaBranch: null,
      metaPeriod: null
    };

    const previewState = {
      page: 1,
      size: 50,
      total: 0,
      pages: 0,
      filters: null
    };

    // ========= フィルタ関連 =========
    function getFilters() {
      const branchVal = document.getElementById("filter-branch").value.trim();
      const periodVal = document.getElementById("filter-period").value;
      const accountVal = document.getElementById("filter-account").value.trim();

      const filters = {
        branch: branchVal || null,
        period: periodVal || null,
        string: []
      };

      if (accountVal) {
        filters.string.push({ col: "勘定科目", val: accountVal });
      }

      // 金額（数値条件）
      const op = document.getElementById("filter-num-op").value;
      const numVal = document.getElementById("filter-num-val").value.trim();
      if (numVal) {
        // サーバ側で対応していなければ、ここはコメントアウトしておいてOK
        filters.num = { op, val: numVal }; // 参考：将来の拡張用に温存
      }

      // 日付範囲
      const df = document.getElementById("filter-date-from").value;
      const dt = document.getElementById("filter-date-to").value;
      if (df || dt) {
        filters.date = { from: df || null, to: dt || null }; // 参考：将来の拡張用に温存
      }

      return filters;
    }

    // URL生成（download_all_json / download_all_csv 共通）
    function buildFilterUrl(filters, json = false, page = 1, size = 50) {
      const endpoint = json
        ? `${API_BASE}/download_all_json`
        : `${API_BASE}/download_all_csv`;
      const url = new URL(endpoint); // API_BASE が絶対URLなのでOK

      if (filters?.branch) url.searchParams.append("branch", filters.branch);
      if (filters?.period) url.searchParams.append("period", filters.period);

      if (filters?.string && filters.string.length > 0) {
        filters.string.forEach(f => {
          url.searchParams.append("filter_col", f.col);
          url.searchParams.append("filter_val", f.val);
        });
      }

      // ※ num/date は将来拡張向け（現APIが未対応なら送らない）
      // if (filters?.num) { ... }
      // if (filters?.date) { ... }

      if (json) {
        url.searchParams.append("page", page ?? 1);
        url.searchParams.append("size", size ?? 50);
      }
      return url.toString();
    }

    // ========= アップロード =========
    document.getElementById("upload-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const branch = document.getElementById("branch-name").value.trim();
      const period = document.getElementById("period").value;
      const file = document.getElementById("csv-file").files[0];

      if (!branch || !period || !file) {
        document.getElementById("upload-status").innerHTML = `<p class="text-danger">支店名・対象月・ファイルは必須です。</p>`;
        return;
      }

      const formData = new FormData();
      formData.append("branch_name", branch);
      formData.append("period", period);
      formData.append("file", file);

      try {
        const res = await apiFetch(`${API_BASE}/`, {
          method: "POST",
          body: formData,
        });
        const data = await res.json();

        if (!res.ok) {
          document.getElementById("upload-status").innerHTML =
            `<p class="text-danger">❌ ${data.detail || "アップロードに失敗しました。「CSVファイル（10MB以下）のみアップロード可能です」"}</p>`;
          return;
        }

        document.getElementById("upload-status").innerHTML =
          `<p class="text-success">✅ アップロード成功：${data.file}（${data.row_count} 件）</p>`;

        await loadExpenses();      // 履歴テーブルを更新
        document.getElementById("upload-form").reset();

      } catch (err) {
        console.error(err);
        document.getElementById("upload-status").innerHTML =
          `<p class="text-danger">❌ 通信エラーが発生しました。</p>`;
      }
    });

    // ========= 履歴一覧 =========
    async function loadExpenses(branchFilter = "", periodFilter = "") {
      try {
        let url = `${API_BASE}`;
        const params = new URLSearchParams();
        if (branchFilter) params.append("branch", branchFilter);
        if (periodFilter) params.append("period", periodFilter);
        const qs = params.toString();
        if (qs) url += "?" + qs;

        const res = await apiFetch(url);
        if (!res.ok) {
          alert("アップロード履歴の取得に失敗しました。");
          return;
        }
        const json = await res.json();
        allData = Array.isArray(json) ? json : (json.data || []);
        currentPage = 1;
        renderListTable();
      } catch (e) {
        console.error("loadExpenses error:", e);
        alert("履歴の取得でエラーが発生しました。");
      }
    }

    function renderListTable() {
      const tbody = document.getElementById("expense-body");
      tbody.innerHTML = "";

      if (!Array.isArray(allData) || allData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-muted text-center">まだデータがありません。</td></tr>`;
        document.getElementById("pageInfo").textContent = "";
        document.getElementById("prevPage").disabled = true;
        document.getElementById("nextPage").disabled = true;
        return;
      }

      const start = (currentPage - 1) * pageSize;
      const pageData = allData.slice(start, start + pageSize);

      pageData.forEach((item) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${item.branch_name || "－"}</td>
          <td>${item.period || "－"}</td>
          <td>${item.file_name}</td>
          <td>${item.row_count}</td>
          <td>${item.uploaded_at}</td>
          <td>
            <button class="btn btn-sm btn-info me-1 btn-detail">詳細</button>
            <button class="btn btn-sm btn-success btn-dl">DL</button>
          </td>
        `;
        tbody.appendChild(tr);

        tr.querySelector(".btn-detail").addEventListener("click", () => showDetails(item.id));
        tr.querySelector(".btn-dl").addEventListener("click", () => downloadCSV(item.branch_name, item.period));
      });

      const totalPages = Math.ceil(allData.length / pageSize) || 1;
      document.getElementById("pageInfo").textContent = `ページ ${currentPage} / ${totalPages}`;
      document.getElementById("prevPage").disabled = currentPage <= 1;
      document.getElementById("nextPage").disabled = currentPage >= totalPages;
    }

    document.getElementById("reload-history").addEventListener("click", async () => {
      const branch = document.getElementById("history-branch").value.trim();
      const period = document.getElementById("history-period").value;
      await loadExpenses(branch, period);
    });

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) { currentPage--; renderListTable(); }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      const totalPages = Math.ceil(allData.length / pageSize) || 1;
      if (currentPage < totalPages) { currentPage++; renderListTable(); }
    });

    // ========= 詳細モーダル =========
    async function showDetails(datasetId, filterVal = "") {
      detailState.datasetId = datasetId;
      detailState.filterVal = filterVal;
      detailState.page = 1;
      detailState.size = parseInt(document.getElementById("detailPageSize").value, 10) || 20;

      await loadDetailPage();

      if (!detailState.modal) {
        detailState.modal = new bootstrap.Modal(document.getElementById("detailModal"));
      }
      detailState.modal.show();
    }

    async function loadDetailPage() {
      const { datasetId, filterVal, page, size } = detailState;
      let url = `${API_BASE}/${datasetId}?page=${page}&size=${size}`;
      if (filterVal) {
        url += `&filter_col=${encodeURIComponent("社員名")}&filter_val=${encodeURIComponent(filterVal)}`;
      }

      const res = await apiFetch(url);
      const data = await res.json();
      const body = document.getElementById("detail-body");

      if (!res.ok) {
        body.innerHTML = `<p class="text-danger">${data.detail || "取得に失敗しました。"}</p>`;
        return;
      }

      const rows = data.data || [];
      detailState.metaBranch = data.meta?.branch_name || rows[0]?.["支店名"] || "";
      detailState.metaPeriod = data.meta?.period || rows[0]?.["対象月"] || "";
      document.getElementById("detail-branch").textContent = detailState.metaBranch;
      document.getElementById("detail-period").textContent = detailState.metaPeriod;

      const customOrder = ["支店名", "対象月", "日付", "金額", "勘定科目", "備考"];
      const headers = rows[0] ? customOrder.filter(h => Object.keys(rows[0]).includes(h)) : [];

      body.innerHTML = rows.length
        ? `<table class="table table-bordered table-sm">
             <thead><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead>
             <tbody>${rows.map(r => `<tr>${headers.map(h => `<td>${r[h] ?? ""}</td>`).join("")}</tr>`).join("")}</tbody>
           </table>`
        : "<p>該当データなし</p>";

      detailState.total = data.meta?.total || rows.length;
      const totalPages = Math.ceil(Math.max(detailState.total, 1) / size);
      document.getElementById("detailPageInfo").textContent = `ページ ${page} / ${totalPages}（全 ${detailState.total} 件）`;
    }

    document.getElementById("detailPrev").addEventListener("click", async () => {
      if (detailState.page > 1) {
        detailState.page -= 1;
        await loadDetailPage();
      }
    });

    document.getElementById("detailNext").addEventListener("click", async () => {
      const maxPage = Math.ceil(Math.max(detailState.total, 1) / detailState.size);
      if (detailState.page < maxPage) {
        detailState.page += 1;
        await loadDetailPage();
      }
    });

    document.getElementById("detailPageSize").addEventListener("change", async (e) => {
      detailState.size = parseInt(e.target.value, 10) || 20;
      detailState.page = 1;
      await loadDetailPage();
    });

    document.getElementById("downloadFilteredCSV").addEventListener("click", () => {
      const url = new URL(`${API_BASE}/download_all_csv`);
      if (detailState.metaBranch) url.searchParams.append("branch", detailState.metaBranch);
      if (detailState.metaPeriod) url.searchParams.append("period", detailState.metaPeriod);
      if (detailState.filterVal) {
        url.searchParams.append("filter_col", "社員名");
        url.searchParams.append("filter_val", detailState.filterVal);
      }
      window.open(url.toString(), "_blank");
    });

    // ========= CSVダウンロード（履歴行のDLボタン用） =========
    function downloadCSV(branch, period) {
      const url = new URL(`${API_BASE}/download_all_csv`);
      if (branch) url.searchParams.append("branch", branch);
      if (period) url.searchParams.append("period", period);
      window.open(url.toString(), "_blank");
    }

// =======================
// 🔍 プレビュー（支店名・対象月・金額・勘定科目・備考）
// =======================
async function loadPreviewPage() {
  const area = document.getElementById("preview-area");
  const thead = document.querySelector("#preview-table thead");
  const tbody = document.querySelector("#preview-table tbody");
  const info = document.getElementById("pvInfo");
  const btnPrev = document.getElementById("pvPrev");
  const btnNext = document.getElementById("pvNext");

  const url = buildFilterUrl(previewState.filters, true, previewState.page, previewState.size);
  const res = await apiFetch(url);

  let data = {};
  try {
    data = await res.json();
  } catch (_) {
    data = {};
  }

  // ❌ データがない場合の処理
  if (!res.ok || !data.data || data.data.length === 0) {
    thead.innerHTML = "";
    tbody.innerHTML = "";
    document.getElementById("preview-count").textContent = "該当データはありません。";
    area.style.display = "block";
    btnPrev.disabled = btnNext.disabled = true;
    info.textContent = "";
    return;
  }

  const rows = data.data;
  previewState.total = data.meta?.total ?? rows.length;
  previewState.pages = Math.ceil(Math.max(previewState.total, 1) / previewState.size);

  // ✅ 表示順を固定
  const headers = ["支店名", "対象月", "金額", "勘定科目", "備考"];

  // 🧭 ヘッダー生成
  thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`;

  // 🧾 データ行生成
  tbody.innerHTML = rows
    .map(r => `<tr>${headers.map(h => `<td>${r?.[h] ?? ""}</td>`).join("")}</tr>`)
    .join("");

  // 📝 ページング・件数表示
  info.textContent = `ページ ${previewState.page} / ${previewState.pages}（全 ${previewState.total} 件）`;
  btnPrev.disabled = previewState.page <= 1;
  btnNext.disabled = previewState.page >= previewState.pages;
  document.getElementById("preview-count").textContent =
    `表示件数：${rows.length} 件（1ページあたり ${previewState.size} 件）`;

  area.style.display = "block";
}


    document.getElementById("previewByFilters").addEventListener("click", async () => {
      previewState.filters = getFilters();
      previewState.page = 1;
      previewState.size = parseInt(document.getElementById("pvPageSize").value, 10) || 50;
      await loadPreviewPage();
    });

    document.getElementById("pvPrev").addEventListener("click", async () => {
      if (previewState.page > 1) {
        previewState.page -= 1;
        await loadPreviewPage();
      }
    });

    document.getElementById("pvNext").addEventListener("click", async () => {
      if (previewState.page < previewState.pages) {
        previewState.page += 1;
        await loadPreviewPage();
      }
    });

    document.getElementById("pvPageSize").addEventListener("change", async (e) => {
      previewState.size = parseInt(e.target.value, 10) || 50;
      previewState.page = 1;
      await loadPreviewPage();
    });

    document.getElementById("downloadByFilters").addEventListener("click", () => {
      const url = buildFilterUrl(getFilters(), false);
      window.open(url, "_blank");
    });

    // ========= 初期ロード =========
    window.addEventListener("DOMContentLoaded", async () => {
      await loadExpenses();
    });
  </script>
</body>
</html>
